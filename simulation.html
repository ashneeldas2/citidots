<!DOCTYPE html>

<html>

<head>

    <title>CitiDots</title>

    <style>
    #map {
        height: 100%;
        width: 50%;
    }
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    </style>

</head>

<body>

    <div id="map"></div>

    <script src="js/jquery-3.1.1.min.js"></script>
    <script>
    var filename = 'data/data.json';
    var bikes;
    $.getJSON(filename, function(json) {
        bikes = json;
    });


    function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14,
            center: {lat: 40.738517, lng: -73.982786},
            mapTypeId: 'terrain'
        });

        var activeBikes = [];
        var ticks = 0;
        var nycAngle = 29 * (Math.PI / 180);

        function debug(bikeid){
            var a = new google.maps.Circle({
                strokeColor: '#1C68A5',//'#39A2E1',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#1C68A5',
                fillOpacity: 1,
                map: map,
                center: {lat: bikes[bikeid].startLoc[0], lng: bikes[bikeid].startLoc[1]},
                radius: 20,
            });
            var b = new google.maps.Circle({
                strokeColor: '#1C68A5',//'#39A2E1',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#1C68A5',
                fillOpacity: 1,
                map: map,
                center: {lat: bikes[bikeid].endLoc[0], lng: bikes[bikeid].endLoc[1]},
                radius: 20,
            });
            console.log(b.center.lat(),b.center.lng());
        }

        function whichDirection(bike){
            var x = bike.endLoc['lng'];
            var y = bike.endLoc['lat'];
            var newX = x * Math.cos(nycAngle) + y * Math.sin(nycAngle);
            var newY = -x * Math.sin(nycAngle) + y * Math.cos(nycAngle);
        }
        window.setInterval(function(){

            for (var bikeid in bikes){
                if (bikes[bikeid].starttime == ticks){
                    activeBikes.push( new google.maps.Circle({
                        strokeColor: '#1C68A5',//'#39A2E1',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#1C68A5',
                        fillOpacity: 1,
                        map: map,
                        center: {lat: bikes[bikeid].startLoc[0], lng: bikes[bikeid].startLoc[1]},
                        radius: 20,
                        startLoc: {lat: bikes[bikeid].startLoc[0], lng: bikes[bikeid].startLoc[1]},
                        endLoc: {lat: bikes[bikeid].endLoc[0], lng: bikes[bikeid].endLoc[1]},
                        angle: nycAngle,
                        bikeid: bikeid,
                        v: 0.0001,
                        hasTurned: false,
                    }));
                }
            }

            activeBikes.forEach(function(bike) {

                var sX = bike.startLoc['lng'];
                var sY = bike.startLoc['lat'];
                var eX = bike.endLoc['lng'];
                var eY = bike.endLoc['lat'];

                var p = bike.getCenter();
                var m = p.lng() + bike.v*(Math.sin(bike.angle));
                var g = p.lat() + bike.v*(Math.cos(bike.angle));

                // inverse calculations due to the x-axis' pointing north

                var eNX =

                var riseAngle = Math.atan((eX-sX)/(eY-sY)) - nycAngle;
                var north = Math.cos(riseAngle) >= 0;
                var east = Math.sin(riseAngle) >= 0;

                var totalDistance = Math.sqrt(Math.pow((eX-sX),2) + Math.pow((eY-sY), 2));
                var distanceTravelled = Math.sqrt(Math.pow(bike.startLoc['lat']-p.lat(),2) + Math.pow(bike.startLoc['lng']-p.lng(),2));

                if (north && east) {
                    if (!bike.hasTurned && distanceTravelled > totalDistance * Math.cos(riseAngle)) {
                        bike.angle += Math.PI / 2;
                        bike.hasTurned = true;
                    }
                    if (bike.hasTurned && p.lat() < eY) {
                        activeBikes.splice(activeBikes.indexOf(bike),1);
                    }
                }

                /*if (north && !east) {
                    if (!bike.hasTurned && distanceTravelled > totalDistance * Math.cos(riseAngle)) {
                        bike.angle -= Math.PI / 2;
                        bike.hasTurned = true;
                    }
                    if (bike.hasTurned && p.lat() > eY) {
                        activeBikes.splice(activeBikes.indexOf(bike),1);
                    }
                }*/

                else {activeBikes.splice(activeBikes.indexOf(bike),1);}



                if ($.inArray(bike, activeBikes) == -1) bike.setMap(null);

                bike.setCenter(new google.maps.LatLng(g,m));
                bike.setRadius(bike.radius);

                });
                ticks++;
        }, 10);
    }

    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDD4D0sdKpinsipvNkqe1UVGgMb7GmNqJ8&callback=initMap"></script>

</body>
</html>
